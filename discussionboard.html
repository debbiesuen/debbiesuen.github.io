import pygame
import sys

# Initialize pygame
pygame.init()

# Screen dimensions
SCREEN_WIDTH = 800
SCREEN_HEIGHT = 600
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Food Waste Reduction System")

# Colors
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
GREEN = (0, 255, 0)
RED = (255, 0, 0)
BLUE = (0, 0, 255)
GRAY = (200, 200, 200)

# Fonts
font = pygame.font.Font(None, 36)

# Donations list
donations = []

# Button class to handle buttons
class Button:
    def __init__(self, text, x, y, width, height, color, action=None):
        self.text = text
        self.x = x
        self.y = y
        self.width = width
        self.height = height
        self.color = color
        self.action = action
    
    def draw(self):
        pygame.draw.rect(screen, self.color, (self.x, self.y, self.width, self.height))
        text_surface = font.render(self.text, True, BLACK)
        screen.blit(text_surface, (self.x + (self.width - text_surface.get_width()) // 2, self.y + (self.height - text_surface.get_height()) // 2))
    
    def is_clicked(self, pos):
        x, y = pos
        if self.x <= x <= self.x + self.width and self.y <= y <= self.y + self.height:
            return True
        return False

# Input fields
fields = []
current_input = ""
input_step = 0
action_mode = None
recipient_mode = False
error_message = ""

# Function to display donations
def display_donations():
    """Display donations list."""
    y_offset = 150
    draw_text("Available Donations:", BLUE, 50, 50)
    for donation in donations:
        draw_text(f"Food: {donation['name']}, Quantity: {donation['quantity']}kg", GREEN, 50, y_offset)
        y_offset += 40

# Function to draw text on screen
def draw_text(text, color, x, y):
    """Render and draw text."""
    text_surface = font.render(text, True, color)
    screen.blit(text_surface, (x, y))

# Function to add a donation
def add_donation():
    """Handle adding a donation."""
    global input_step, current_input, fields, error_message
    if input_step == 0:
        fields = ["Enter food name:", "Enter quantity (kg):", "Enter shelf life (days):", "Enter location:"]
        current_input = ""
        error_message = ""
    if input_step == 1:
        fields[0] = f"Food name: {current_input}"
    if input_step == 2:
        fields[1] = f"Quantity (kg): {current_input}"
    if input_step == 3:
        fields[2] = f"Shelf life (days): {current_input}"
    if input_step == 4:
        fields[3] = f"Location: {current_input}"
        # Adding donation to list
        donations.append({"name": fields[0].split(":")[1].strip(), "quantity": float(fields[1].split(":")[1].strip()), "location": fields[3].split(":")[1].strip()})
        error_message = f"Donation added: {fields[0].split(':')[1].strip()} - {fields[1].split(':')[1].strip()} kg"
        input_step = 0  # Reset input step for next donation

# Function to match recipient
def match_recipient():
    """Handle matching recipient."""
    global recipient_mode, input_step, fields, current_input
    if recipient_mode:
        if input_step == 0:
            fields = ["Enter recipient food:", "Enter quantity requested (kg):", "Enter recipient location:"]
            current_input = ""
        if input_step == 1:
            fields[0] = f"Recipient food: {current_input}"
        if input_step == 2:
            fields[1] = f"Quantity requested (kg): {current_input}"
        if input_step == 3:
            fields[2] = f"Recipient location: {current_input}"
            # Matching recipient
            matched = []
            requested_food = fields[0].split(":")[1].strip()
            requested_quantity = float(fields[1].split(":")[1].strip())
            location = fields[2].split(":")[1].strip()
            for donation in donations[:]:
                if donation["name"] == requested_food and donation["location"] == location and donation["quantity"] >= requested_quantity:
                    matched.append(donation)
                    donation["quantity"] -= requested_quantity  # Remove matched quantity
                    if donation["quantity"] == 0:
                        donations.remove(donation)  # Remove if quantity becomes 0
            if matched:
                error_message = f"Matched recipient with {len(matched)} food items in {location}: {matched[0]['name']}, {matched[0]['quantity']}kg"
            else:
                error_message = "No suitable recipient found."
            recipient_mode = False
            input_step = 0

# Main loop
running = True
buttons = [
    Button("Add Donation", 50, 50, 200, 50, GREEN, add_donation),
    Button("Match Recipient", 50, 150, 200, 50, BLUE, match_recipient),
    Button("Exit", 50, 250, 200, 50, RED, sys.exit)
]

while running:
    screen.fill(WHITE)

    # Draw buttons
    for button in buttons:
        button.draw()

    # Display input fields and current data
    y_offset = 300
    for i, field in enumerate(fields):
        draw_text(field, BLACK, 50, y_offset + i * 40)

    # Display error message
    if error_message:
        draw_text(error_message, RED, 50, y_offset + len(fields) * 40)

    # Check for events
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        if event.type == pygame.MOUSEBUTTONDOWN:
            pos = pygame.mouse.get_pos()
            # Check if any button is clicked
            for button in buttons:
                if button.is_clicked(pos):
                    button.action()

        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_RETURN:
                input_step += 1
                if input_step == 4:
                    add_donation()  # Finish adding donation after the last step
                elif input_step == 3:
                    match_recipient()  # Finish recipient matching

            elif event.key == pygame.K_BACKSPACE:
                current_input = current_input[:-1]
            else:
                current_input += event.unicode

    pygame.display.flip()

pygame.quit()
